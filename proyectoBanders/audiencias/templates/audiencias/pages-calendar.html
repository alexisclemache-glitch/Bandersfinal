{% extends 'vertical.html' %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .calendar-wrapper { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #edf2f9; }
    #calendar { padding: 20px; min-height: 650px; }
    .agenda-sidebar { background-color: #f8fafc; border-left: 1px solid #edf2f9; height: 100%; min-height: 650px; }
    .agenda-header { padding: 25px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #edf2f9; margin-bottom: 15px; }

    .agenda-list-item { border: none; border-left: 5px solid; padding: 16px; border-radius: 12px; margin: 0 15px 15px 15px; transition: all 0.3s ease; cursor: pointer; position: relative; background: #fff; }
    .agenda-list-item:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .agenda-time { font-size: 12px; font-weight: 800; margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
    .agenda-desc { font-size: 14px; color: #1e293b; font-weight: 700; line-height: 1.2; padding-right: 20px; margin-bottom: 4px; }
    .agenda-client { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 4px; }

    .btn-sync-mini {
        padding: 2px 6px; background: #f0f7ff; color: #4285F4; border-radius: 4px; font-size: 14px; transition: 0.2s;
    }
    .btn-sync-mini:hover { background: #4285F4; color: white; }

    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h3 class="fw-bold text-dark m-0">Calendario Judicial</h3>
                <p class="text-muted small">Gestión de audiencias y citas de asesoría</p>
            </div>
            <button class="btn btn-primary px-4 py-2 fw-bold shadow-lg" id="btn-nuevo-evento" style="border-radius: 12px;">
                <i class="ri-add-fill fs-5"></i> Agendar Cita/Audiencia
            </button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="row g-0">
            <div class="col-xl-9 col-lg-8"><div id="calendar"></div></div>
            <div class="col-xl-3 col-lg-4">
                <div class="agenda-sidebar">
                    <div class="agenda-header">
                        <span class="fw-bold text-dark"><i class="ri-calendar-todo-fill text-primary me-2"></i>AGENDA DEL DÍA</span>
                        <span id="event-count" class="badge bg-soft-primary text-primary rounded-pill">0</span>
                    </div>
                    <div id="agenda-dinamica"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{# MODAL DE EVENTO #}
<div class="modal fade" id="event-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="form-audiencia" class="modal-content shadow-lg" style="border-radius: 20px;">
            {% csrf_token %}
            <input type="hidden" name="audiencia_id" id="aud_id">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="fw-bold text-primary" id="modal-title-text"><i class="ri-edit-2-line me-2"></i>Detalles de la Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="p-3 rounded-3 mb-2" style="background: #f1f5f9; border: 1px dashed #cbd5e1;">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="check_es_asesoria">
                                <label class="form-check-label fw-bold text-dark" for="check_es_asesoria">
                                    <i class="ri-customer-service-2-fill me-1 text-primary"></i> ¿Es una Asesoría Directa? (Sin Expediente)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" id="container-expediente">
                        <label class="fw-bold small text-muted">EXPEDIENTE</label>
                        {{ form.expediente }}
                    </div>
                    <div class="col-12">
                        <label class="fw-bold small text-muted" id="label-titulo">ASUNTO / NOMBRE DEL INTERESADO</label>
                        {{ form.titulo }}
                    </div>
                    <div class="col-md-6"><label class="fw-bold small text-muted">INICIO</label>{{ form.fecha_inicio }}</div>
                    <div class="col-md-6"><label class="fw-bold small text-muted">CIERRE</label>{{ form.fecha_fin }}</div>
                    <div class="col-md-5"><label class="fw-bold small text-muted">PRIORIDAD</label>{{ form.color_categoria }}</div>
                    <div class="col-md-7"><label class="fw-bold small text-muted">ABOGADOS ASIGNADOS</label>{{ form.usuarios_asignados }}</div>
                    <div class="col-12"><label class="fw-bold small text-muted">OBSERVACIONES</label>{{ form.descripcion }}</div>
                </div>
                <div id="google-sync-wrapper" class="mt-4 p-4 rounded-4 text-center" style="display: none; background-color: #f0f7ff; border: 2px dashed #4285F4;">
                    <a href="#" id="btn-google-sync" target="_blank" class="btn btn-primary shadow-sm rounded-pill px-4 py-2">
                        <i class="ri-google-fill me-2"></i> Sincronizar con Google Calendar
                    </a>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 d-flex justify-content-between">
                <button type="button" class="btn btn-outline-danger px-4 fw-bold" id="btn-eliminar" style="display: none; border-radius: 10px;">
                    <i class="ri-delete-bin-line"></i> Eliminar
                </button>
                <div>
                    <button type="button" class="btn btn-light px-4 me-2" data-bs-dismiss="modal" style="border-radius: 10px;">Cerrar</button>
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-bold" style="border-radius: 10px;">Guardar</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_javascript %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        $('.select2-single, .select2-multiple').select2({ dropdownParent: $('#event-modal'), width: '100%' });

        const agendaContainer = document.getElementById('agenda-dinamica');
        const eventModal = new bootstrap.Modal(document.getElementById('event-modal'));
        const btnEliminar = document.getElementById('btn-eliminar');
        const googleSyncWrapper = document.getElementById('google-sync-wrapper');
        const btnGoogleSync = document.getElementById('btn-google-sync');

        $('#check_es_asesoria').on('change', function() {
            if ($(this).is(':checked')) {
                $('#container-expediente').slideUp();
                $('#id_expediente').val(null).trigger('change');
                $('#label-titulo').text("NOMBRE DEL CLIENTE (PROSPECTO)");
            } else {
                $('#container-expediente').slideDown();
                $('#label-titulo').text("ASUNTO DE LA AUDIENCIA");
            }
        });

        const formatToLocalISO = (date) => {
            if (!date) return "";
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().slice(0, 16);
        };

        function getGoogleUrl(title, start, end) {
            const base = "https://www.google.com/calendar/render?action=TEMPLATE";
            const fmt = (date) => date ? date.toISOString().replace(/-|:|\.\d\d\d/g, "") : "";
            const s = fmt(new Date(start));
            const e = end ? fmt(new Date(end)) : fmt(new Date(new Date(start).getTime() + 3600000));
            return `${base}&text=${encodeURIComponent(title)}&dates=${s}/${e}`;
        }

        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            locale: 'es',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            events: JSON.parse('{{ eventos_json|safe }}'),
            dateClick: function(info) { renderAgenda(info.dateStr); },
            eventClick: function(info) { abrirModal(info.event); }
        });
        calendar.render();

        function renderAgenda(dateStr) {
            const selectedDate = new Date(dateStr + "T00:00:00").toDateString();
            const now = new Date();
            const filtered = calendar.getEvents().filter(e => e.start && e.start.toDateString() === selectedDate);
            document.getElementById('event-count').innerText = filtered.length;

            let html = '';
            filtered.sort((a, b) => a.start - b.start).forEach(e => {
                const color = e.backgroundColor || '#6366f1';
                const horaLocal = e.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const esAsesoria = !e.extendedProps.expediente_id;
                const gUrl = getGoogleUrl(e.title, e.start, e.end);

                const partes = e.title.split('|');
                const cliente = esAsesoria ? "CITAR: PROSPECTO" : (partes[0] || "Expediente");
                const asunto = esAsesoria ? e.title.replace('CIT: ', '') : (partes.length > 1 ? partes[1].trim() : partes[0].trim());

                html += `
                    <div class="agenda-list-item shadow-sm" style="border-left-color: ${color};">
                        <div class="agenda-time" style="color: ${color}">
                            <span><i class="${esAsesoria ? 'ri-chat-voice-line' : 'ri-time-fill'} me-1"></i>${horaLocal}</span>
                            <a href="${gUrl}" target="_blank" class="btn-sync-mini" title="Sincronizar Google">
                                <i class="ri-google-fill"></i>
                            </a>
                        </div>
                        <div class="agenda-desc text-truncate" onclick="triggerEventClick('${e.id}')">${asunto}</div>
                        <div class="agenda-client" onclick="triggerEventClick('${e.id}')">
                            <i class="ri-user-line"></i> ${cliente}
                        </div>
                    </div>`;
            });
            agendaContainer.innerHTML = html || `<p class="text-center py-5 text-muted small">Sin citas agendadas.</p>`;
        }

        function abrirModal(ev) {
            if (!ev) return;
            $('#aud_id').val(ev.id);
            if (!ev.extendedProps.expediente_id) {
                $('#check_es_asesoria').prop('checked', true).trigger('change');
                $('#id_titulo').val(ev.title.replace('CIT: ', ''));
            } else {
                $('#check_es_asesoria').prop('checked', false).trigger('change');
                $('#id_titulo').val(ev.title.includes('|') ? ev.title.split('|').pop().trim() : ev.title);
                $('#id_expediente').val(ev.extendedProps.expediente_id).trigger('change');
            }
            $('#id_color_categoria').val(ev.extendedProps.prioridad).trigger('change');
            $('#id_usuarios_asignados').val(ev.extendedProps.abogados).trigger('change');
            $('#id_descripcion').val(ev.extendedProps.descripcion || '');
            $('#id_fecha_inicio').val(formatToLocalISO(ev.start));
            if(ev.end) $('#id_fecha_fin').val(formatToLocalISO(ev.end));

            btnGoogleSync.href = getGoogleUrl(ev.title, ev.start, ev.end);
            googleSyncWrapper.style.display = 'block';
            btnEliminar.style.display = 'block';
            eventModal.show();
        }

        window.triggerEventClick = (id) => {
            const ev = calendar.getEventById(id);
            if (ev) abrirModal(ev);
        };

        $('#btn-nuevo-evento').click(() => {
            $('#form-audiencia')[0].reset();
            $('#aud_id').val('');
            $('#check_es_asesoria').prop('checked', false).trigger('change');
            $('select').val(null).trigger('change');
            googleSyncWrapper.style.display = 'none';
            btnEliminar.style.display = 'none';
            eventModal.show();
        });

        $('#form-audiencia').on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                url: $('#aud_id').val() ? `/audiencias/accion/${$('#aud_id').val()}/` : "/audiencias/accion/",
                type: 'POST', data: $(this).serialize(),
                success: function() { location.reload(); },
                error: function() { alert("Error al guardar."); }
            });
        });

        $('#btn-eliminar').click(function() {
            if (confirm('¿Eliminar cita?')) {
                $.ajax({
                    url: `/audiencias/eliminar/${$('#aud_id').val()}/`,
                    type: 'POST', data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                    success: function() { location.reload(); }
                });
            }
        });

        const d = new Date();
        renderAgenda(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
    });
</script>
{% endblock %}