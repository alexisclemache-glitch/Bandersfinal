{% extends "vertical.html" %}
{% load static %}

{% block page_content %}
<style>
    .modal-premium {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 40px !important;
        border: none;
    }

    .visa-card-premium {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%);
        border-radius: 28px;
        padding: 25px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(30, 27, 75, 0.4);
        min-height: 220px;
        color: white;
    }

    .chip-gold {
        width: 50px;
        height: 38px;
        background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .txn-text {
        font-family: 'Courier New', Courier, monospace;
        font-size: 1.2rem;
        letter-spacing: 3px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .avatar-circle {
        width: 80px;
        height: 80px;
        background: #6366f1;
        color: white;
        font-size: 32px;
        font-weight: bold;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: -40px auto 15px;
        border: 5px solid white;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .historial-container {
        background: #f8fafc;
        border-radius: 25px;
        padding: 20px;
    }

    .extra-small { font-size: 0.65rem; }
    .fs-14 { font-size: 14px; }
    tr.pago-row:hover { background-color: #f0fdf4 !important; }
</style>

<div class="container-fluid py-4">
    <div class="d-flex align-items-center mb-4">
        <div class="flex-grow-1">
            <h4 class="fw-bold text-dark mb-1">Resultados de búsqueda</h4>
            <p class="text-muted mb-0 small">Buscando: <span class="fw-bold text-primary">"{{ query }}"</span> — {{ total_resultados }} coincidencias.</p>
        </div>
    </div>

    {# SECCIÓN DE PAGOS / TRANSACCIONES #}
    {% if resultados_pagos %}
    <div class="card border-0 shadow-sm rounded-4 mb-4" style="border-left: 5px solid #10b981 !important;">
        <div class="card-header bg-transparent border-0 pt-3 ps-4">
            <h6 class="fw-bold text-success mb-0">
                <i class="ri-money-dollar-circle-fill me-1"></i> Transacciones y Pagos
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light small fw-bold">
                        <tr>
                            <th class="ps-4">ID TRANSACCIÓN</th>
                            <th>CONCEPTO</th>
                            <th>CLIENTE</th>
                            <th>TOTAL DEUDA</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in resultados_pagos %}
                        <tr class="pago-row" onclick="abrirVisaPremium('{{ pago.id }}')" style="cursor: pointer;">
                            <td class="ps-4">
                                <code class="fw-bold text-primary fs-14">{{ pago.transaccion_id }}</code>
                            </td>
                            <td class="small">{{ pago.get_concepto_display }}</td>
                            <td>{{ pago.expediente.cliente.nombre }} {{ pago.expediente.cliente.apellido }}</td>
                            <td class="fw-bold">${{ pago.total_deuda|floatformat:0 }}</td>
                            <td>
                                <span class="badge rounded-pill {% if pago.estado == 'completado' %}bg-success{% else %}bg-warning{% endif %}">
                                    {{ pago.get_estado_display|upper }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {# SECCIÓN DE EXPEDIENTES #}
    {% if resultados_expedientes %}
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-header bg-transparent border-0 pt-3 ps-4">
            <h6 class="fw-bold text-dark mb-0">
                <i class="ri-folder-2-fill me-1 text-primary"></i> Expedientes Jurídicos
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light small fw-bold">
                        <tr>
                            <th class="ps-4">TÍTULO / CASO</th>
                            <th>CLIENTE</th>
                            <th>PROCESO</th>
                            <th class="text-end pe-4">ACCIÓN</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exp in resultados_expedientes %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold">{{ exp.titulo }}</div>
                                <div class="text-muted extra-small">{{ exp.tipo_expediente }}</div>
                            </td>
                            <td>{{ exp.cliente.nombre }} {{ exp.cliente.apellido }}</td>
                            <td><span class="text-muted small">{{ exp.numero_proceso|default:"---" }}</span></td>
                            <td class="text-end pe-4">
                                <a href="{% url 'clientes:detail' exp.cliente.pk %}" class="btn btn-sm btn-outline-dark rounded-pill px-3">Ver Perfil</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="modalPremium" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
        <div class="modal-content modal-premium shadow-lg">
            <div class="modal-body p-4 text-center">
                <div class="avatar-circle" id="v-avatar">?</div>
                <h3 class="fw-bold mt-2 mb-0 text-dark" id="v-nombre">Cargando...</h3>
                <p class="text-muted small mb-4">Banders Financial Elite</p>

                <div class="visa-card-premium text-start mb-4">
                    <div class="chip-gold"></div>
                    <div class="txn-text mb-4" id="v-txn">TXN-0000 0000</div>
                    <div class="row align-items-end mt-4">
                        <div class="col-8">
                            <small class="opacity-60 d-block mb-1" style="font-size: 11px;">SALDO PENDIENTE</small>
                            <span class="h3 fw-bold text-warning mb-0" id="v-saldo">$ 0</span>
                        </div>
                        <div class="col-4 text-end">
                            <i class="ri-visa-line" style="font-size: 45px; opacity: 0.8;"></i>
                        </div>
                    </div>
                </div>

                <div class="historial-container text-start">
                    <h6 class="fw-bold small text-secondary mb-3" style="letter-spacing: 1px;">HISTORIAL DE ABONOS</h6>
                    <div id="v-historial" class="mb-0 overflow-auto" style="max-height: 180px;">
                        </div>
                </div>

                <div class="mt-4 d-flex gap-2">
                    <a href="#" id="v-ws" target="_blank" class="btn btn-success w-100 rounded-pill py-2">
                        <i class="ri-whatsapp-line"></i> WhatsApp
                    </a>
                    <a href="#" id="v-pdf" class="btn btn-dark w-100 rounded-pill py-2">
                        <i class="ri-file-pdf-line"></i> Recibo
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function abrirVisaPremium(id) {
    fetch(`/pagos/detalle-json/${id}/`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('v-nombre').innerText = data.nombre;
            document.getElementById('v-avatar').innerText = data.inicial;
            // Formato de tarjeta: separa el TXN con espacios
            let txnRaw = data.txn.replace(/-/g, ' ');
            document.getElementById('v-txn').innerText = txnRaw;
            document.getElementById('v-saldo').innerText = '$ ' + data.saldo.toLocaleString();
            document.getElementById('v-ws').href = data.ws_link;
            document.getElementById('v-pdf').href = `/pagos/exportar-pdf/${id}/`;

            let html = '';
            if (data.abonos && data.abonos.length > 0) {
                data.abonos.forEach(a => {
                    html += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <span class="fw-bold text-dark">$${a.monto}</span><br>
                            <span class="text-muted extra-small">${a.fecha}</span>
                        </div>
                        <i class="ri-checkbox-circle-fill text-success"></i>
                    </div>`;
                });
            } else {
                html = '<p class="text-center py-3 text-muted small">Sin abonos registrados.</p>';
            }
            document.getElementById('v-historial').innerHTML = html;

            new bootstrap.Modal(document.getElementById('modalPremium')).show();
        });
}

// Apertura automática si la vista manda el ID exacto
document.addEventListener("DOMContentLoaded", function() {
    {% if abrir_pago_id %}
        abrirVisaPremium('{{ abrir_pago_id }}');
    {% endif %}
});
</script>
{% endblock %}