{% extends "vertical.html" %}
{% load static %}

{% block page_content %}
<div class="container-fluid">
    {# --- HEADER DE PERFIL --- #}
    <div class="row align-items-center mb-4">
        <div class="col-sm-6">
            <h4 class="fw-bold text-dark mb-1">Perfil del Cliente</h4>
            <p class="text-muted small mb-0">Gestión de expedientes y documentos de <strong>{{ cliente.nombre }} {{ cliente.apellido }}</strong>.</p>
        </div>
        <div class="col-sm-6 text-sm-end mt-3 mt-sm-0">
            <a href="{% url 'clientes:list' %}" class="btn btn-white btn-sm border-0 shadow-sm rounded-pill px-3 me-2">
                <iconify-icon icon="solar:double-alt-arrow-left-bold-duotone" class="align-middle me-1"></iconify-icon> Volver
            </a>
            <a href="{% url 'expedientes:lista_expedientes' %}?cliente={{ cliente.id }}" class="btn btn-success btn-sm rounded-pill px-3 shadow me-2">
                <iconify-icon icon="solar:folder-add-bold-duotone" class="align-middle me-1"></iconify-icon> Abrir Expediente
            </a>
            <a href="{% url 'clientes:update' cliente.pk %}" class="btn btn-primary btn-sm rounded-pill px-3 shadow">
                <iconify-icon icon="solar:pen-new-square-bold-duotone" class="align-middle me-1"></iconify-icon> Editar Datos
            </a>
        </div>
    </div>

    <div class="row">
        {# --- COLUMNA IZQUIERDA: INFORMACIÓN Y BÓVEDA --- #}
        <div class="col-xl-4 col-lg-5">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                <div class="bg-primary p-4 text-center" style="background: linear-gradient(45deg, #4f46e5, #7c3aed)!important;">
                    {% if cliente.foto %}
                        <img src="{{ cliente.foto.url }}" class="rounded-circle border border-4 border-white shadow-lg mb-2" style="width: 110px; height: 110px; object-fit: cover;">
                    {% else %}
                        <div class="avatar-xl bg-white-subtle rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 border border-2 border-white-50" style="width: 110px; height: 110px;">
                            <span class="fs-1 fw-bold text-white">{{ cliente.nombre|slice:":1" }}</span>
                        </div>
                    {% endif %}
                    <h4 class="text-white fw-bold mb-0">{{ cliente.nombre }} {{ cliente.apellido }}</h4>
                    <p class="text-white-50 small mb-0">{{ cliente.email|default:"Sin correo electrónico" }}</p>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        {% if cliente.esta_activo %}
                            <span class="badge bg-success-subtle text-success px-3 rounded-pill fw-bold" style="font-size: 11px;">● CLIENTE ACTIVO</span>
                        {% else %}
                            <span class="badge bg-danger-subtle text-danger px-3 rounded-pill fw-bold" style="font-size: 11px;">● CLIENTE INACTIVO</span>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                        <span class="text-muted small fw-medium">CÉDULA / RUC</span>
                        <span class="text-dark fw-bold small">{{ cliente.rut }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-2 border-bottom">
                        <span class="text-muted small fw-medium">RESIDENCIA</span>
                        <span class="text-dark fw-bold small text-end">{{ cliente.canton|default:"-" }}<br><span class="text-muted fw-normal">{{ cliente.provincia|upper }}</span></span>
                    </div>

                    <div class="mb-4 pb-2 border-bottom">
                        <span class="text-muted small fw-medium d-block mb-1">DIRECCIÓN DOMICILIARIA</span>
                        <span class="text-dark fw-bold small d-block" style="line-height: 1.3;">{{ cliente.direccion|default:"No registrada" }}</span>
                    </div>

                    {% if cliente.telefono %}
                    <a href="https://wa.me/593{{ cliente.telefono|cut:' ' }}" target="_blank" class="btn btn-success w-100 rounded-pill fw-bold py-2 shadow-sm border-0" style="background-color: #25D366;">
                        <iconify-icon icon="logos:whatsapp-icon" class="align-middle me-2"></iconify-icon> CONTACTAR WHATSAPP
                    </a>
                    {% endif %}
                </div>
            </div>

            {# BÓVEDA PERSONAL #}
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                    <h3 class="fw-bold text-dark mb-0 small"><iconify-icon icon="solar:safe-square-bold-duotone" class="text-primary me-1"></iconify-icon> Bóveda Personal</h3>
                    <button class="btn btn-dark btn-sm rounded-pill px-3 py-1 shadow-sm" style="font-size: 10px;" data-bs-toggle="modal" data-bs-target="#modalDocumentoGeneral">SUBIR A BÓVEDA</button>
                </div>
                <div class="card-body pt-0">
                    <div class="list-group list-group-flush">
                        {% for doc in cliente.documentos.all %}
                        <div class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center py-2 border-bottom-dashed">
                            <div class="d-flex align-items-center">
                                <iconify-icon icon="solar:file-text-bold-duotone" class="text-primary fs-4 me-2"></iconify-icon>
                                <div>
                                    <span class="small text-dark fw-bold d-block text-truncate" style="max-width: 150px;">{{ doc.titulo }}</span>
                                    <span class="badge bg-light text-muted fw-normal" style="font-size: 8px;">{{ doc.get_categoria_display|upper }}</span>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ doc.archivo.url }}" target="_blank" class="btn btn-sm btn-light p-1 rounded-circle shadow-sm"><iconify-icon icon="solar:eye-bold" class="text-muted"></iconify-icon></a>
                                <a href="{% url 'clientes:delete_document' doc.pk %}" class="btn btn-sm btn-soft-danger p-1 rounded-circle shadow-sm" onclick="return confirm('¿Borrar de la bóveda?')"><iconify-icon icon="solar:trash-bin-trash-bold"></iconify-icon></a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 bg-light rounded-3 border border-dashed">
                            <p class="text-muted small mb-0">Sin documentos en bóveda.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# --- COLUMNA DERECHA: EXPEDIENTES --- #}
        <div class="col-xl-8 col-lg-7">
            <h5 class="fw-bold text-dark mb-3">Expedientes Judiciales Activos</h5>

            {% for exp in cliente.expedientes_juridicos.all %}
            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden border-start border-4 border-primary">
                <div class="card-body p-0">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light-subtle border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-soft-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 42px; height: 42px;">
                                <iconify-icon icon="solar:folder-with-files-bold-duotone" class="text-primary fs-4"></iconify-icon>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold text-dark">{{ exp.titulo|upper }}</h6>
                                <span class="badge rounded-pill bg-soft-success text-success" style="font-size: 9px;">{{ exp.estado|upper }} | {{ exp.tipo_expediente|upper }}</span>
                            </div>
                        </div>
                        <button class="btn btn-soft-dark btn-sm rounded-pill px-3 fw-bold small" data-bs-toggle="modal" data-bs-target="#modalDocExp{{ exp.id }}">
                            <iconify-icon icon="solar:upload-minimalistic-bold" class="me-1"></iconify-icon> Adjuntar Escrito
                        </button>
                    </div>

                    <div class="p-3">
                        <div class="row g-4">
                            <div class="col-md-7 border-end">
                                <p class="text-muted small fw-bold mb-3 text-uppercase">Historial de Actuaciones</p>
                                <form method="post" class="mb-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="btn_nota_expediente" value="1">
                                    <input type="hidden" name="expediente_id" value="{{ exp.id }}">
                                    <div class="input-group shadow-sm">
                                        <textarea name="contenido" class="form-control form-control-sm bg-light" rows="1" placeholder="Registrar avance judicial..." required></textarea>
                                        <button class="btn btn-primary btn-sm px-3" type="submit">Guardar</button>
                                    </div>
                                </form>

                                <div class="timeline-container">
                                    {% for nota in exp.notas_seguimiento.all %}
                                    <div class="timeline-item d-flex mb-3">
                                        <div class="timeline-dot"></div>
                                        <div class="ms-3 w-100">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="badge bg-light text-muted border" style="font-size: 9px;">{{ nota.fecha_creacion|date:"d M, Y" }}</span>
                                                <small class="text-muted fw-bold">{{ nota.autor.username }}</small>
                                            </div>
                                            <p class="mb-0 small text-dark" style="line-height: 1.4;">{{ nota.contenido }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-5">
                                <p class="text-muted small fw-bold mb-3 text-uppercase">Escritos Procesales</p>
                                <div class="list-group list-group-flush">
                                    {% for doc in exp.archivos_expediente.all %}
                                    <div class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center py-2 border-bottom-dashed">
                                        <div class="d-flex align-items-center">
                                            <iconify-icon icon="solar:file-text-bold-duotone" class="text-primary fs-5 me-2"></iconify-icon>
                                            <span class="small text-truncate pe-2" style="max-width: 120px;" title="{{ doc.nombre }}">{{ doc.nombre }}</span>
                                        </div>
                                        <div class="d-flex gap-1">
                                            <a href="{{ doc.archivo.url }}" class="btn btn-sm btn-soft-primary p-1 rounded-circle" target="_blank">
                                                <iconify-icon icon="solar:download-bold"></iconify-icon>
                                            </a>
                                            <a href="{% url 'clientes:delete_escrito' doc.pk %}" class="btn btn-sm btn-soft-danger p-1 rounded-circle" onclick="return confirm('¿Eliminar escrito?')">
                                                <iconify-icon icon="solar:trash-bin-trash-bold"></iconify-icon>
                                            </a>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-3 bg-light rounded-3">
                                        <p class="text-muted small mb-0">Sin documentos adjuntos.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# MODAL ADJUNTAR ESCRITO #}
            <div class="modal fade" id="modalDocExp{{ exp.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 border-0 shadow-lg">
                        <form action="{% url 'clientes:upload_expediente_document' exp.id %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="modal-header border-0 pb-0">
                                <h6 class="fw-bold mb-0">Adjuntar al Expediente</h6>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted">Nombre del Escrito</label>
                                    <input type="text" name="nombre" class="form-control form-control-sm" required>
                                </div>
                                <div class="mb-2">
                                    <label class="small fw-bold text-muted">Seleccionar Archivo</label>
                                    <input type="file" name="archivo" class="form-control form-control-sm" required>
                                </div>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="submit" class="btn btn-primary btn-sm rounded-pill w-100 fw-bold py-2">Subir Documento</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="card border-0 shadow-sm rounded-4 text-center py-5">
                <iconify-icon icon="solar:folder-error-bold-duotone" class="text-muted display-4"></iconify-icon>
                <p class="text-muted mt-2">Este cliente no tiene expedientes registrados.</p>
                <a href="{% url 'expedientes:lista_expedientes' %}?cliente={{ cliente.id }}" class="btn btn-primary btn-sm mx-auto rounded-pill px-4">Crear Expediente Ahora</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{# MODAL BÓVEDA GENERAL #}
<div class="modal fade" id="modalDocumentoGeneral" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <form action="{% url 'clientes:upload_document' cliente.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h6 class="fw-bold mb-0">Nueva Carga a Bóveda</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Título (Cédula, Poder, etc.)</label>
                        <input type="text" name="titulo" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Categoría</label>
                        <select name="categoria" class="form-select form-select-sm" required>
                            <option value="identidad">Identidad</option>
                            <option value="contrato">Contratos</option>
                            <option value="otros" selected>Otros</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold text-muted">Archivo</label>
                        <input type="file" name="archivo" class="form-control form-control-sm" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary btn-sm rounded-pill w-100 fw-bold py-2 shadow">Guardar en Bóveda</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .bg-soft-primary { background-color: rgba(79, 70, 229, 0.1); color: #4f46e5; }
    .bg-soft-success { background-color: rgba(34, 197, 94, 0.1); color: #16a34a; }
    .bg-soft-danger { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .bg-soft-dark { background-color: #f8fafc; color: #475569; border: 1px solid #e2e8f0; }
    .border-bottom-dashed { border-bottom: 1px dashed #e2e8f0; }
    .timeline-container { position: relative; padding-left: 5px; }
    .timeline-item { position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; }
    .timeline-dot {
        position: absolute; left: -6px; top: 6px; width: 10px; height: 10px;
        background-color: #4f46e5; border-radius: 50%; border: 2px solid #fff;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }
    .btn-white { background-color: #fff; color: #334155; }
    .list-group-item:last-child { border-bottom: none !important; }
</style>
{% endblock %}