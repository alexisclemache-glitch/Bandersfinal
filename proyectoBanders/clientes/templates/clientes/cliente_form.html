{% extends "vertical.html" %}
{% load static %}

{% block page_content %}
<div class="container-fluid py-4">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row g-4">

            <div class="col-xl-3 col-lg-4">
                <div class="card shadow-sm border-0 rounded-4">
                    <div class="card-body">
                        <div id="square-preview" class="customer-bg rounded-4 shadow-sm"
                             style="background-image: url('{% if form.instance.foto %}{{ form.instance.foto.url }}{% else %}{% static 'images/small/img-1.jpg' %}{% endif %}');
                                    background-size: cover; background-position: center; height: 180px;">
                        </div>
                        <div class="mt-3">
                            <label class="form-label fw-bold small">Fotografía del Cliente</label>
                            <input type="file" name="foto" id="input-foto" class="form-control form-control-sm border-0 bg-light" accept="image/*">

                            <div class="mt-4">
                                <label class="form-label small fw-bold text-uppercase text-muted" style="font-size: 0.65rem;">Configuración de Cuenta</label>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Estado Operativo</label>
                                    <select name="estado_operativo" class="form-select bg-light border-0">
                                        {% for val, label in form.fields.estado_operativo.choices %}
                                            <option value="{{ val }}" {% if form.estado_operativo.value == val or form.instance.estado_operativo == val %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-check form-switch p-0 ms-4">
                                    <input class="form-check-input" type="checkbox" name="esta_activo" id="id_esta_activo"
                                           {% if form.esta_activo.value or form.instance.esta_activo %}checked{% endif %}>
                                    <label class="form-check-label fw-bold small" for="id_esta_activo">¿Cliente Vigente?</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-9 col-lg-8">
                <div class="card shadow-sm border-0 rounded-4">
                    <div class="card-header bg-transparent border-bottom border-dashed py-3">
                        <h4 class="card-title mb-0 fw-bold text-primary">
                            <iconify-icon icon="solar:user-id-bold-duotone" class="align-middle me-1"></iconify-icon>
                            {% if form.instance.pk %}Editar Ficha de Cliente{% else %}Registro de Nuevo Cliente{% endif %}
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Nombres</label>
                                <input type="text" name="nombre" class="form-control bg-light border-0" value="{{ form.nombre.value|default:'' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Apellidos</label>
                                <input type="text" name="apellido" class="form-control bg-light border-0" value="{{ form.apellido.value|default:'' }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Cédula / RUC</label>
                                <input type="text" name="rut" class="form-control bg-light border-0" value="{{ form.rut.value|default:'' }}" required>
                                {% if form.rut.errors %}
                                    <div class="text-danger small mt-1">{{ form.rut.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Correo Electrónico</label>
                                <input type="email" name="email" class="form-control bg-light border-0" value="{{ form.email.value|default:'' }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Teléfono / WhatsApp</label>
                                <input type="text" name="telefono" class="form-control bg-light border-0" value="{{ form.telefono.value|default:'' }}" placeholder="Ej: 0991234567">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Estado Civil</label>
                                <select name="estado_civil" class="form-select bg-light border-0">
                                    {% for val, label in form.fields.estado_civil.choices %}
                                        <option value="{{ val }}" {% if form.estado_civil.value == val or form.instance.estado_civil == val %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Provincia</label>
                                <select name="provincia" class="form-select bg-light border-0">
                                    {% for val, label in form.fields.provincia.choices %}
                                        <option value="{{ val }}" {% if form.provincia.value == val or form.instance.provincia == val %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Cantón / Ciudad</label>
                                <input type="text" name="canton" class="form-control bg-light border-0" value="{{ form.canton.value|default:'' }}">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label small fw-bold">Dirección Domiciliaria</label>
                                <textarea name="direccion" class="form-control bg-light border-0" rows="3" placeholder="Ej: Calle 10 de Agosto y Rocafuerte...">{{ form.direccion.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end gap-2 bg-light-subtle py-3 border-0 px-4">
                        <a href="{% url 'clientes:list' %}" class="btn btn-light rounded-pill px-4 fw-bold">Cancelar</a>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow">
                            <iconify-icon icon="solar:diskette-bold" class="align-middle me-1"></iconify-icon>
                            {% if form.instance.pk %}Actualizar Ficha{% else %}Registrar Cliente{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form> </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputFoto = document.getElementById('input-foto');
        if (inputFoto) {
            inputFoto.addEventListener('change', function(e) {
                const reader = new FileReader();
                reader.onload = function() {
                    document.getElementById('square-preview').style.backgroundImage = `url(${reader.result})`;
                }
                if(e.target.files[0]) {
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }
    });
</script>
{% endblock %}